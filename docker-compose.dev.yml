services:
  trikusec-manager:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: trikusec-manager-dev
    volumes:
      - ./src:/app
      - frontend-certs:/app/certs
    environment:
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DJANGO_ENV=development
      - DJANGO_DEBUG=True
      - DJANGO_ALLOWED_HOSTS=*
      - TRIKUSEC_DB_DIR=/app/data
      - TRIKUSEC_URL=http://trikusec-manager-dev:8000
      - TRIKUSEC_LYNIS_API_URL=https://trikusec-lynis-api-dev:8001
      - TRIKUSEC_ADMIN_USERNAME=admin
      - TRIKUSEC_ADMIN_PASSWORD=trikusec
      - TRIKUSEC_LICENSE_KEY=${TRIKUSEC_LICENSE_KEY:-aaaaaaaa-bbbbbbbb-cccccccc}
      - PORT=8000
      - WSGI_APPLICATION=trikusec.wsgi_frontend:application
      - DJANGO_SSL_ENABLED=False
      - DJANGO_SSL_CERTFILE=/app/certs/cert.pem
      - DJANGO_SSL_KEYFILE=/app/certs/key.pem
      - DJANGO_SSL_KEYFILE=/app/certs/key.pem
      - SKIP_COLLECTSTATIC=True
      - TZ=${TZ:-UTC}
      - TZ=${TZ:-UTC}
      - DJANGO_TIME_ZONE=${DJANGO_TIME_ZONE:-UTC}
    command: python manage.py runserver 0.0.0.0:8000
    ports:
      - 8000:8000
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - default

  trikusec-lynis-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: trikusec-lynis-api-dev
    volumes:
      - ./src:/app
      - api-certs:/app/certs
    environment:
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
      - DJANGO_ENV=development
      - DJANGO_DEBUG=True
      - DJANGO_ALLOWED_HOSTS=*
      - TRIKUSEC_DB_DIR=/app/data
      - TRIKUSEC_LYNIS_API_URL=https://trikusec-lynis-api-dev:8001
      - PORT=8001
      - WSGI_APPLICATION=trikusec.wsgi_api:application
      - DJANGO_SSL_ENABLED=True
      - DJANGO_SSL_CERTFILE=/app/certs/cert.pem
      - DJANGO_SSL_KEYFILE=/app/certs/key.pem
      - SSL_CN=trikusec-lynis-api-dev
      - SKIP_MIGRATIONS=True
      - SKIP_COLLECTSTATIC=True
      - TZ=${TZ:-UTC}
    restart: unless-stopped
    depends_on:
      trikusec-manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-skf", "https://localhost:8001/health/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - default

  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: trikusec-test
    volumes:
      - ./src:/app
      - ./pytest.ini:/app/pytest.ini
    environment:
      - SECRET_KEY=${SECRET_KEY:-test-secret-key-for-testing}
      - DJANGO_ENV=testing
      - DJANGO_DEBUG=False
      - DJANGO_ALLOWED_HOSTS=*
      - DJANGO_ALLOW_ASYNC_UNSAFE=True
      - DJANGO_TEST_DB_NAME=/app/data/trikusec-dev.sqlite3
      - TRIKUSEC_URL=http://trikusec-manager-dev:8000
      - TRIKUSEC_LYNIS_API_URL=https://trikusec-lynis-api-dev:8001
      - TRIKUSEC_LYNIS_API_VERIFY_SSL=false
      - TRIKUSEC_LICENSE_KEY=${TRIKUSEC_LICENSE_KEY:-aaaaaaaa-bbbbbbbb-cccccccc}
      - TZ=${TZ:-UTC}
    working_dir: /app
    command: ["pytest", "-v", "--cov=api", "--cov=frontend", "--cov-report=term-missing"]
    profiles:
      - test
    depends_on:
      trikusec-manager:
        condition: service_healthy
      trikusec-lynis-api:
        condition: service_healthy
    networks:
      - default

  test-e2e:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: trikusec-test-e2e
    volumes:
      - ./src:/app
      - ./pytest.ini:/app/pytest.ini
    environment:
      - SECRET_KEY=${SECRET_KEY:-test-secret-key-for-testing}
      - DJANGO_ENV=testing
      - DJANGO_DEBUG=False
      - DJANGO_ALLOWED_HOSTS=*
      - DJANGO_ALLOW_ASYNC_UNSAFE=True
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - TRIKUSEC_URL=http://trikusec-manager-dev:8000
      - TRIKUSEC_LYNIS_API_URL=https://trikusec-lynis-api-dev:8001
      - TZ=${TZ:-UTC}
    working_dir: /app
    command: ["pytest", "-v", "-m", "e2e"]
    profiles:
      - test
    depends_on:
      trikusec-manager:
        condition: service_healthy
    networks:
      - default

  lynis-client:
    build:
      context: .
      dockerfile: lynis/Dockerfile
    container_name: lynis-client
    environment:
      - TRIKUSEC_SERVER_URL=https://trikusec-lynis-api-dev:8001
      - TRIKUSEC_LICENSE_KEY=${TRIKUSEC_LICENSE_KEY:-aaaaaaaa-bbbbbbbb-cccccccc}
      - DEBIAN_FRONTEND=noninteractive
    depends_on:
      trikusec-lynis-api:
        condition: service_healthy
    networks:
      - default
    command: ["/test/run-lynis-test.sh"]

volumes:
  frontend-certs:
  api-certs:

networks:
  default:
    name: trikusec-dev-network
